<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Scanner</title>
  <link rel="icon" href="https://hamusata.f5.si/favicon.ico" type="image/x-icon">
  
  <style>
:root{
  --accent:#3399ff;
  --accent-hover:#1673e6;
  --error:#d33;
  --link:#4CAF50;
  --card-bg:rgba(255,255,255,.88);
  --bg:linear-gradient(180deg,#f9e6e7 0%,#fce8d8 30%,#d9f0e6 70%,#a8d0e6 100%);
}

*{box-sizing:border-box}

html,body{
  width:100%;
  height:100%;
  margin:0;
}

body{
  display:grid;
  place-items:center;
  background:var(--bg);
  font-family:'Inter','Segoe UI','Hiragino Kaku Gothic ProN',Arial,sans-serif;
}

.container{
  display:grid;
  justify-items:center;
  gap:1rem;
  width:min(92vw,520px);
  padding:2.2rem 2rem;
  background:var(--card-bg);
  backdrop-filter:blur(12px);
  border-radius:24px;
  box-shadow:0 8px 24px rgba(0,0,0,.12);
  text-align:center;
}

h1{
  margin:0 0 .8rem;
  font-size:2rem;
  color:#333;
}

button{
  width:80%;
  max-width:260px;
  padding:.85rem;
  font-size:1.1rem;
  font-weight:700;
  border:none;
  border-radius:14px;
  background:var(--accent);
  color:#fff;
  cursor:pointer;
  box-shadow:0 6px 15px rgba(51,153,255,.6);
}

button:hover{background:var(--accent-hover)}

#cameraSelect{
  width:80%;
  max-width:240px;
  padding:.7rem;
  font-size:1rem;
  font-weight:600;
  border-radius:12px;
  border:2px solid #ccc;
}

#reader{
  width:100%;
  max-width:360px;
}

#scanResult{
  display:none;
  font-size:1.15rem;
  font-weight:700;
  word-break:break-all;
}

#resetBtn{
  display:none;
  background:var(--error);
  font-size:.95rem;
  padding:.55rem 1rem;
}

#resetBtn:hover{background:#b00}

input[type=file]{
  width:80%;
  max-width:240px;
  padding:.5rem;
  font-size:1rem;
  border-radius:12px;
  border:1px solid #ccc;
  cursor:pointer;
}

footer{
  font-size:.85rem;
  color:#555;
}

a{
  color:var(--link);
  text-decoration:none;
}

a:hover{text-decoration:underline}
</style>

</head>

<body>
  
  <main class="container">
    <h1>QR Code Scanner</h1>

    <button id="cameraToggleBtn">カメラON</button>
    <button id="torchBtn">ライトON</button>

    <select id="cameraSelect">
      <option value="">カメラ読み込み中...</option>
    </select>

    <div id="reader"></div>

    <p style="margin-top:1.5rem;">カメラで読み取れない場合は画像をアップロード:</p>
    <input type="file" id="fileInput" accept="image/*">

    <div id="resultBox">
      <span id="scanResult"></span><br>
      <button id="resetBtn">リセット</button>
    </div>

    <footer id="footer-copy"></footer>
  </main>

  <script src="https://unpkg.com/html5-qrcode"></script>
 
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

  <script>
    const footer = document.getElementById("footer-copy");
    const baseYear = 2025;
    const currentYear = new Date().getFullYear();
    const yearString = `${baseYear}${currentYear > baseYear ? "–" + currentYear : ""}`;
    const hostname = location.hostname;
    let footerHTML = "";

    if (hostname === "hamuzon.github.io") {
      footerHTML = `&copy; ${yearString} <a class="link" href="https://hamuzon.github.io" target="_blank" rel="noopener noreferrer">@hamuzon</a>`;
    } else if (hostname.includes("hamuzon-jp.f5.si")) {
      footerHTML = `&copy; ${yearString} <a class="link" href="https://hamuzon-jp.f5.si" target="_blank" rel="noopener noreferrer">@hamuzon</a>`;
    } else if (hostname.includes("hamusata.f5.si")) {
      footerHTML = `&copy; ${yearString} <a class="link" href="https://hamusata.f5.si" target="_blank" rel="noopener noreferrer">@hamusata</a>`;
    } else if (hostname.includes("qr.link-s.f5.si")) {
      footerHTML = `&copy; ${yearString} <a class="link" href="https://hamusata.f5.si" target="_blank" rel="noopener noreferrer">@hamusata</a>`;
    } else {
      footerHTML = `&copy; ${yearString} QR Code Scanner`;
    }
    footer.innerHTML = footerHTML;
  </script>

 <script>
    footerHTML += `<p>
      このサービスは
      <a class="link" href="https://unpkg.com/html5-qrcode" target="_blank">html5-qrcode</a> と
      <a class="link" href="https://unpkg.com/jsqr/dist/jsQR.js" target="_blank">jsQR</a>
      を使用しています。
    </p>`;
    footer.innerHTML = footerHTML;

    const html5QrCode = new Html5Qrcode("reader");
    const cameraToggleBtn = document.getElementById("cameraToggleBtn");
    const cameraSelect = document.getElementById("cameraSelect");
    const scanResult = document.getElementById("scanResult");
    const resetBtn = document.getElementById("resetBtn");
    const fileInput = document.getElementById("fileInput");
    const torchBtn = document.getElementById("torchBtn");

    let cameraRunning = false;
    let isTorchOn = false;

    async function loadCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        cameraSelect.innerHTML = "";
        let backCameraId = null;
        devices.forEach((cam, i) => {
          const opt = document.createElement("option");
          opt.value = cam.id;
          opt.textContent = cam.label || `カメラ ${i + 1}`;
          cameraSelect.appendChild(opt);
          if (cam.label.toLowerCase().includes("back") ||
            cam.label.toLowerCase().includes("rear") ||
            cam.label.toLowerCase().includes("environment")) {
            backCameraId = cam.id;
          }
        });
        if (backCameraId) {
          cameraSelect.value = backCameraId;
        }
      } catch (err) {
        console.error(err);
        cameraSelect.innerHTML = '<option>カメラ取得エラー</option>';
        alert("カメラ一覧の取得に失敗しました\n\n" + (err?.message ?? String(err)));
      }
    }
    loadCameras();

    function isURL(str) {
      return /^https?:\/\//i.test(str);
    }

    function showResult(text) {
      scanResult.innerHTML = isURL(text) ? `<a class="link" href="${text}" target="_blank">${text}</a>` : text;
      scanResult.style.display = "inline-block";
      resetBtn.style.display = "inline-block";
    }

    function resetScan() {
      scanResult.textContent = "";
      scanResult.style.display = "none";
      resetBtn.style.display = "none";
    }
    resetBtn.onclick = resetScan;

    cameraToggleBtn.onclick = async () => {
      if (cameraRunning) {
        try {
          await html5QrCode.stop();
          cameraRunning = false;
          cameraToggleBtn.textContent = "カメラON";
          torchBtn.style.display = "none";
          isTorchOn = false;
          torchBtn.textContent = "ライトON";
        } catch (err) {
          console.error(err);
        }
        return;
      }
      try {
        resetScan();
        const camId = cameraSelect.value;
        const config = {
          fps: 10,
          qrbox: 250
        };
        await html5QrCode.start(
          camId ? camId : { facingMode: "environment" },
          config,
          txt => showResult(txt)
        );
        cameraRunning = true;
        cameraToggleBtn.textContent = "カメラOFF";
        try {
          const capabilities = html5QrCode.getRunningTrackCameraCapabilities();
          if (capabilities && capabilities.torch) {
            torchBtn.style.display = "block";
          }
        } catch (e) {
          console.error(e);
        }
      } catch (err) {
        console.error(err);
        alert("カメラ開始に失敗しました\n\n" + (err?.message ?? String(err)) + "\n\n※ HTTPS / 権限 / 他アプリ使用中 を確認してください");
      }
    };

    torchBtn.onclick = async () => {
      try {
        isTorchOn = !isTorchOn;
        await html5QrCode.applyVideoConstraints({
          advanced: [{
            torch: isTorchOn
          }]
        });
        torchBtn.textContent = isTorchOn ? "ライトOFF" : "ライトON";
      } catch (err) {
        console.error(err);
        alert("ライトの切り替えに失敗しました");
        isTorchOn = !isTorchOn;
      }
    };

    fileInput.onchange = e => {
      resetScan();
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      img.onload = () => {
        try {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, img.width, img.height);
          const code = jsQR(imageData.data, img.width, img.height);
          showResult(code ? code.data : "QRコードが見つかりません");
        } catch (err) {
          console.error(err);
          alert("画像の解析に失敗しました\n\n" + (err?.message ?? String(err)));
        }
      };
      img.src = URL.createObjectURL(file);
    };

  </script>

</body>

</html>
