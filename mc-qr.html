<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Minecraft-QR-Generator</title>
<meta name="description" content="MinecraftのQR建築に最適なQRコードを生成します。黒と白のコンクリートでマイクラ風に表現。">
<meta name="keywords" content="Minecraft, QRコード, QR, コンクリート, マイクラ, 建築, QR generator, MC QR">
<meta name="robots" content="index, follow">
<style>
:root{
  --color-accent:#3399ff;
  --color-accent-light:#7fbfff;
  --bg-gradient: linear-gradient(180deg,#f9e6e7 0%,#fce8d8 30%,#d9f0e6 70%,#a8d0e6 100%);
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
  background: var(--bg-gradient);
  padding:1rem;
  color:#333;
}
main.container{
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(10px);
  border-radius: 1.5rem;
  width:100%;
  max-width:640px;
  padding:2rem;
  text-align:center;
  box-shadow:0 8px 24px rgba(0,0,0,0.1);
}
h1{
  font-size:2rem;
  margin-bottom:1rem;
}
input[type="text"], input[type="number"]{
  padding:0.5rem;
  font-size:1rem;
  border:2px solid var(--color-accent);
  border-radius:10px;
  outline:none;
  transition:0.3s;
  text-align:center;
}
input:focus{border-color:var(--color-accent-light);}
#buttonGroup{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  margin:0.5rem 0;
}
button{
  flex:1;
  padding:0.6rem 1rem;
  margin:0.2rem;
  border:none;
  border-radius:14px;
  background: var(--color-accent);
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
  min-width:120px;
}
button:hover{background:var(--color-accent-light);}
#blockqr{
  margin-top:1rem;
  max-width:100%;
  image-rendering: pixelated;
  border:2px solid #555;
}
.guide{
  font-size:0.8rem;
  margin-top:0.5rem;
  text-align:left;
}
.guide label{
  font-weight: normal;
  font-size:0.85rem;
}
footer{
  margin-top:1.5rem;
  font-size:0.75rem;
  color:#666;
}
footer a{
  color:#3399ff;
  text-decoration:none;
}
footer a:hover{text-decoration:underline;}
@media(max-width:480px){
  #buttonGroup{flex-direction:column;}
  button{width:100%;}
}
</style>
</head>
<body>
<main class="container">
  <h1>Minecraft-QR-Generator</h1>
  <input type="text" id="inputText" placeholder="URL or Text">
  <div class="guide">
    <p>📌 Minecraft 建築ガイド</p>
    <ul>
      <li>黒 = 黒コンクリート</li>
      <li>白 = 白コンクリート</li>
      <li>1セル = 1ブロック</li>
    </ul>
    <div style="margin-top:0.5rem;">
      <label>最大横ブロック数: <input type="number" id="maxWidth" value="64" min="1" max="128" style="width:60px"></label>
      <label>最大縦ブロック数: <input type="number" id="maxHeight" value="64" min="1" max="128" style="width:60px; margin-left:0.5rem;"></label>
    </div>
  </div>
  <div id="buttonGroup">
    <button onclick="generateMCQR()">Generate QR</button>
    <button onclick="downloadMCQR()">Download PNG</button>
  </div>
  <canvas id="blockqr"></canvas>
  <footer id="footer-copy"></footer>
</main>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script>
let lastText="";

(function(){
  const footer=document.getElementById("footer-copy");
  if(footer){
    footer.innerHTML=`QRCode.js (MIT License) <a href="https://github.com/soldair/node-qrcode" target="_blank">https://github.com/soldair/node-qrcode</a>`;
  }
})();

async function generateMCQR(){
  const text=document.getElementById("inputText").value.trim();
  if(!text){ alert("⚠️ 入力が空です"); return; }
  lastText=text;

  const MAX_WIDTH_BLOCKS = parseInt(document.getElementById("maxWidth").value)||64;
  const MAX_HEIGHT_BLOCKS = parseInt(document.getElementById("maxHeight").value)||64;

  // 一時キャンバスでQRサイズ取得
  const tempCanvas=document.createElement("canvas");
  await QRCode.toCanvas(tempCanvas,text,{width:0,margin:1});
  let moduleCountX=tempCanvas.width;
  let moduleCountY=tempCanvas.height;

  // 最大ブロック数に合わせて比率を維持し縮小
  const scaleX = MAX_WIDTH_BLOCKS / moduleCountX;
  const scaleY = MAX_HEIGHT_BLOCKS / moduleCountY;
  const scale = Math.min(scaleX, scaleY, 1); // 1より大きくはしない
  moduleCountX = Math.floor(moduleCountX * scale);
  moduleCountY = Math.floor(moduleCountY * scale);

  const ctxTemp=tempCanvas.getContext("2d");
  const imgData=ctxTemp.getImageData(0,0,tempCanvas.width,tempCanvas.height).data;

  const blockCanvas=document.getElementById("blockqr");
  const cellSize=Math.floor(Math.min(blockCanvas.parentElement.clientWidth*0.95/moduleCountX,32));
  blockCanvas.width=moduleCountX*cellSize;
  blockCanvas.height=moduleCountY*cellSize;
  const ctx=blockCanvas.getContext("2d");

  const mcBlack="#1D1D21";
  const mcWhite="#F9FFFE";

  for(let y=0;y<moduleCountY;y++){
    for(let x=0;x<moduleCountX;x++){
      // 元の画像から対応する座標をサンプリング
      const origX=Math.floor(x/scale);
      const origY=Math.floor(y/scale);
      const i=(origY*tempCanvas.width+origX)*4;
      const r=imgData[i],g=imgData[i+1],b=imgData[i+2];
      const brightness=(r+g+b)/3;
      ctx.fillStyle=brightness<128?mcBlack:mcWhite;
      ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
      ctx.strokeStyle="#555";
      ctx.strokeRect(x*cellSize,y*cellSize,cellSize,cellSize);
    }
  }
}

function downloadMCQR(){
  const canvas=document.getElementById("blockqr");
  if(!canvas.width){alert("QRコードを生成してください"); return;}
  const link=document.createElement("a");
  link.download="Minecraft-QR.png";
  link.href=canvas.toDataURL("image/png");
  link.click();
}

window.addEventListener('resize',()=>{
  if(lastText){generateMCQR();}
});
</script>
</body>
</html>